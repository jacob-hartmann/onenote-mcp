name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v1.0.0)"
        required: true

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Upgrade npm for trusted publishing (requires 11.5.1+)
        run: npm install -g npm@latest

      - name: Resolve release tag
        id: resolve-tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout release tag (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ steps.resolve-tag.outputs.tag }}
          persist-credentials: false
          fetch-depth: 0

      - name: Verify tag matches package version
        run: |
          RELEASE_TAG="${{ steps.resolve-tag.outputs.tag }}"
          PKG_VERSION="$(node -p "require('./package.json').version")"
          if [ "v${PKG_VERSION}" != "${RELEASE_TAG}" ]; then
            echo "Tag (${RELEASE_TAG}) does not match package.json version (v${PKG_VERSION})."
            exit 1
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Rebuild required native tooling
        run: pnpm rebuild esbuild

      - name: Type check
        run: pnpm run typecheck

      - name: Lint
        run: pnpm run lint

      - name: Format check
        run: pnpm run format:check

      - name: Test
        run: pnpm test

      - name: Build
        run: pnpm build

      - name: Generate SBOM (CycloneDX JSON)
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json
          upload-artifact: false
          upload-release-assets: false

      - name: Publish to npm (Trusted Publishing / OIDC)
        run: |
          PKG_VERSION="$(node -p "require('./package.json').version")"
          case "${PKG_VERSION}" in
            *-*)
              # Avoid setting "latest" to a prerelease. Publish under a prerelease dist-tag.
              npm publish --ignore-scripts --tag rc
              ;;
            *)
              npm publish --ignore-scripts
              ;;
          esac

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: sbom.cyclonedx.json
          generate_release_notes: true
